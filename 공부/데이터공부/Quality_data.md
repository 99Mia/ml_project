### 센서 데이터 모델 성능 향상용 품질 데이터
### 컬럼

## 기본 식별/공정 정보
# udi  
: 제품/검사 고유 ID 
-> 각 제품을 유일하게 식별하는 번호
ML 모델 학습에는 직접 입력 x , 추적/결과 확인용

# product_id 
: 제품 코드 (범주형 feature) 
-> 실제 제품 번호. 제품별 특성 차이를 반영할 수 있음
ML 모델 학습에는 직접 입력 x , 추적/결과 확인용

# product_type 
: 제품 타입 (범주형 feature)
-> M,L 등 제품 종류 구분. 제품 타입에 따라 공정 특성이나 센서 패턴이 달라질 수 있어 모델 입력용
-> 센서 데이터 모델(feature)입력용으로 사용된다.
**이유: 제품 타입 (M,L 등)에 따라 공정 특성, 토크, 공구 마모, 온도 패턴이 달라지기 때문이다.
모델이 정상과 이상을 구분할 때 제품 타입 차이를 반영하면 성능이 올라간다.
**형태: 범주형(feature) -> ML 모델에 따라 one-hot encoding이나 label encoding 으로 변환 후 입력
즉, sensor value 만 넣는 것 보다 제품 타입 + 장비 + 공정 단계 + 센서값을 같이 넣으면 모델이 설비 이상 패턴을 더 정확히 학습할 수 있다



# equipment_id 
: 설비/장비 ID (범주형 feature) 
-> EQ1 ~ EQ4 처럼 공정 장비를 구분
어떤 장비에서 측정했는지 반영, 장비별 이상치 패턴 학습 가능
-> 센서 데이터 모델(feature)에 사용되는 중요한 컬럼이다.
각 측정값이 어떤 장비에서 나왔는지를 나타내는 ID 다.
장비마다
- 센서 패턴이 다를 수 있음 (예 : 토크,온도,진동 등)
- 마모 속도나 발열 특성이 다를 수 있음
- 특정 장비만 이상 신호를 내는 경우가 있을 수 있음
즉, 장비별 특징을 반영해서 모델이 "이 장비에서 측정된 값이 정상인지 이상인지"를 구분할 수 있다
ML 모델에서 사용된다.
--> 범주형(feature)로 입력됨
One-hot encoding : EQ1 -> [1,0,0,0] , EQ2 -> [0,1,0,0] 등
Label encoding : EQ1 -> 0 , EQ2 -> 1
-이렇게 하면 모델이 장비별 센서 패턴 차이를 학습 가능하다
-장비별로 센서값의 정상 범위가 달라서 단순 센서값만 보면 이상치인지 판단하기 어려운 경우가 많다.
하지만 equipment_id를 포함하면 모델이 장비별 기준을 알아서 학습한다.




# process_step 
: 공정 단계 -> A/B/C 등 제조 공정 단계 시뮬레이션
정의 : 제품이 제조되는 과정에서 거치는 단계(Stage, Step)을 나타내는 값이다.
시뮬레이션에서는 단순히 공정 단계를 구분하기 위해 임의로 지정한다.
왜 필요한가?
1. 공정별 센서 패턴 차이 반영
- 공정 단계마다 사용되는 장비,속도,온도,토크 등 센서 값이 다를 수 있다
- 예: 공정 A -> 초벌 가공, 토크 낮음 / 공정 C -> 마무리, 토크 높음
- 모델이 "어떤 단계에서 센서 값이 정상인지" 학습할 수 있다.
2. 공정별 품질 영향
- 불량 발생 확률이 공정 단계마다 다를 수 있다
- 예: 공정 B에서 tool wear가 심하면 치수 오차 증가
3. Residual / 이상치 판단에 도움
- Torque, delta_temp 등 센서값을 공정 단계별 기준으로 비교 가능하다
- 예: 공정 C에서 torque가 높으면 이상 -> Risk Level 산정
센서값 하나만 보면 "정상인지 이상인지" 판단하기 어렵다.
같은 torque라도 어떤 공정 단계에서 측정됐는지에 따라 의미가 달라진다.
process step A 에서 torque_nm 정상 범위는 30~40 으로 , 의미: 초벌 가공 단계, 토크 낮음 정상
process step B 에서 torque_nm 정상 범위는 35~45 으로 , 의미: 중간 가공 단계, 토크 조금 높아도 정상
process step C 에서 torque_nm 정상 범위는 40~50 으로 , 의미: 마무리 단계, 토크 기준치 상한 50
- 만약 공정 C에서 torque가 55라면 -> 정상 범위를 넘어섰다 -> 이상치로 판단
- 반대로 공정 A 에서 torque가 38이면 -> 정상 범위 안 -> 이상 아님

Residual(잔차)은 실제 관측값 - 모델 예측값을 의미한다.
residual = 실제 torque - 예상 torque
즉, 모델이 예측한 정상 범위와 실제 측정값 사이의 차이를 말한다
--> 왜 residual을 쓰는가?
1. 공정 단계, 장비, 제품 타입별 정상 torque를 반영
- 단순히 torque가 높거나 낮다라고 보는 것 보다, "이 제품/장비/단계에서 예상되는 torque와 비교해서 얼마나 벗어났는지 보는게 더 정확하다.
2. 이상치 탐지에 활용
- Residual이 크면 -> 예상 범위에서 벗어남 -> 설비 이상 가능성 -> Risk Level High
정리하면"
Residual = "실제 센서값과 정상 예측값 차이"
크면 클수록 설비 이상 가능성 높다.
Risk Level 계산과 예지보전 의사결정에 바로 활용


** Risk Level 산정과 연결
- 코드에서 residual 과 torque_pred를 이용해 회전수 대비 torque 예상값을 계산
-> 모델(LinearRegression)이 회전수(RPM)를 넣으면 "이 장비/공정/제품에서 정상적인 torque"를 예측해준다 (torque_pred)
-> Residual = 실제 torque - torque_pred
즉, torque가 얼마나 정상 범위를 벗어났는지 계산하는 것


여기에 공정 단계 정보를 고려하면
예상 torque = 공정 단계 + 장비 + 제품 타입 기반 모델
-> 쉽게 말하면:
공정 단계 A,B,C 마다 정상 torque 가 다르다. 장비 EQ1, EQ2 마다도 약간씩 다르다
제품 타입 M/L 마다도 다르다.
따라서 모델은 "공정 단계 + 장비 + 제품 타입"을 고려해서 그 상황에서 정상 torque 를 계산한다

실제 torque > 예상 torque + tolerance -> 이상
이상이면 risk_level = High
-> 여기서 tolerance는 쉽게 말하면 허용 오차 범위이다.

# 용어설명
1. 예상 torque (torque_pred)
- LinearRegression 모델이 정상 상태에서 나와야 할 torque를 계산한 값
2. 실제 torque (torque_nm)
- 센서가 측정한 실제 값
3. Residual = 실제 torque - 예상 torque
-  실제 값이 정상 범위를 얼마나 벗어났는지 확인
4. Tolerance
- 이 정도까지는 정상으로 봐도 된다 는 허용범위
- 코드에서는 보통 Residual > 2*rolling std 같은 값으로 계산
ex.
예상 torque가 40, tolerance가 ±2 -> 실제 torue가 42~38이면 정상, 42 초과면 이상
즉, 공정 단계마다 센서 기준이 다르기 때문에, 어떤 단계에서 이상치가 발생했는지 알아야
Risk Level을 올바르게 판단할 수 있다


** rolling : 이전 N개 데이터의 이동 통계값
rolling = 이동(window)기준 계산
예를 들어 window=5 이면, 현재시점과 이전 4개 데이터를 묶어서 계산
주로 평균, 표준편차(std), 합계 등을 계산할 때 사용
왜 rolling을 쓰는가?
센서 데이터나 공정 데이터는 시계열이라서, 단순히 한 순간의 값만 보면 노이즈 때문에 이상 판단이 어렵다. torque가 순간적으로 살짝 높게 나와도 큰 문제 아닐 수 있다
그래서 최근 몇 개 값의 평균이나 표준편차를 보고 변동성을 확인한다
즉, 노이즈를 줄이고 트렌드/변동성을 확인하는 방법이다.





# tool_replaced 
: 공구 교체 여부 -> 0:교체 안함, 1: 교체함
공구가 닳거나 오래되면 제품 품질과 센서값 (torque, tool_wear)에 영향을 준다.
- 공구 마모 증가
- 절삭 저항 증가
- torque 상승
- 진동/열 증가
- 불량 발생 확률 증가
오래된 공구 -> 마모 높음 -> torque 변동 증가 -> defect 가능성 증가
새 공구 -> 안정적인 공정 -> torque/마모값 정상 범위 유지
** 모델에서 왜 중요한가??
1. 같은 torque라도 공구 상태에 따라 의미가 다름
- 새 공구 + torque 상승 -> 이상 신호 가능성 큼
- 오래된 공구 + torque 상승 -> 자연스러운 현상일 수도 있음
즉, 정상 기준선이 달라짐
2. 모델 활용 방식
- 범주형 feature (0/1 그대로 사용 가능)
- torque_pred 예측 시 입력 변수로 사용
- residual 계산의 정확도 높임



## 센서 측정값
# quality_tool_wear 
공구 마모 시간/레벨 -> 센서 기반 측정값
의미: 공구가 얼마나 오래/ 많이 사용되었는지를 마모 누적을 수치로 표현한 값이다.
해석: 값이 커질수록
- 절삭 품질 저하
- torque 변동성 증가
- 불량 위험 증가
모델 활용:
- 단독 feature 또는 추세(EWMA), 변동성(std)로 확장
- 예지보전의 핵심 지표중 하나
*****
sensor data의 tool_wear_min 과의 비교
1. senser data의 tool_wear_min
정체: 
- 실시간(또는 준실시간)센서 기반 측정값
- PLC / 설비 센서에서 직접 들어오는 값
성격:
- 노이즈 많음
- 순간 튐 있음
- 센서 오차 포함
- 지금 이 순간의 상태
--> sensor_tool_wear_min은 누적형 값이고, 대부분 계단식(step-wise)으로 증가한다.
그런데도 '순간 튐처럼 보이는 현상'이 생길 수 있다.
- 공구 사용 시간
- 공구 마모 카운터
- 가공 시간 누적값
정상 적이면 120 -> 121 -> 122 이런식으로 증가하지만
하지만, 센서 수집이 1초마다, tool_wear 업데이트가 30초 마다
그러면 데이터가 120 -> 125 -> 125 이런식으로 한번에 증가하는데 시계열로 보면 툭 튀는 것 처럼 보이지만, 실제로는 누적이 정상적으로 된 것이다. 그리고 내부 계산 단위 문제(반올림, 소수점 버림), 공정 이벤트 기반 증가 (공구 마모가 시간이 아니라 가공 수행 기준으로 증가하기도 한다)
그러면 가공 한 번 끝나면 +3 이렇게 올라간다.
그리고 리셋 이벤트는 공구 교체시 0으로 돌아가는 것 
--> 이런식으로 노이즈가 있고 순간 튐이 있고 하는게 센서 tool_wear 데이터의 특징인 것이다
"시간 연속 신호"는 아니다. 그래서 값 자체보다 변화 패턴/속도/이벤트 가 더 중요해진다
역할:
- 실시간 이상 탐지
- EWMA / rolling std 계산
- anomaly detection 모델 입력
즉, 지금 센서가 측정한 마모 레벨이다.

2. quality data 의 tool_wear
정체: 
- 품질/이력 기반 공구 마모 상태
- MES, 작업 이력, 정기 점검 결과
- 혹은 사후 집계/보정된 값
성격:
- 상대적으로 안정적
- 노이즈 거의 없음
- 업데이트 주기 느림
- 공구의 상태를 대표하는 값 
역할:
- 기준값(ground truth에 가까움)
- 공정/품질 설명용 feature
- sensor 모델 보정 기준
즉, 이 시점에서 이 공구는 '약 000분 사용된 공구'

| 구분    | sensor tool_wear_min | quality tool_wear |
| ----- | -------------------- | ----------------- |
| 출처    | 실시간 센서               | MES / 품질 / 이력     |
| 노이즈   | 많음                   | 거의 없음             |
| 갱신 주기 | 초/분 단위               | 공정 단위 / 교체 단위     |
| 의미    | 순간 상태                | 대표 상태             |
| 역할    | 탐지 / 추세              | 기준 / 설명           |
| 모델 사용 | 입력 feature           | 조건 / 기준           |

이거 둘을 같은 feature로 합쳐서 쓰면 안된다


***quality tool_wear
- 정상/비정상 기준 설명
- 공구 상태 범주화

if quality_tool_wear > 140:
  공구 = '노후'
els:
  공구 = '양호'
- 모델 기준선 설정
- 해석용 feature
- 보고서/대시보드용

즉, 품질 데이터는 모델 정확도를 올리기보다 모델을 믿을 수 있게 만드는 역할을 한다

면접: 
"sensor tool_wear는 실시간으로 변하는 신호이고, quality tool_wear는 공구 상태를 대표하는 이력기반 기분값입니다. 저는 sensor 데이터는 이상 탐지에, quality 데이터는 기준선과 해석용으로 분리해서 사용했습니다."


# torque_nm 
: 회전 토크 -> 센서 측정값, 모터 부하 상태를 반영
# defect_flag 
: 결함 여부 -> 센서값 + ΔT + EWMA/rolling std 기반 동적 threshold 계산 결과(0:정상, 1: 결함)

# Spec / 기준치 (시뮬레이션)
spec1 : 기준치 1 -> 제품 타입 + 공정 단계 + 공구 교체 여부 기반 목표치
spec2 : 기준치 2 -> 제품 타입 + 공정 단계 + 공구 교체 여부 기반 목표치

--> 센서값과는 별개로 "정상 범위/설계 기준치" 역할

# 동적 이상치 판단용 지표 (EWMA / Rolling std)
# tool_wear_min_ewma 
: tool wear EWMA -> 최근 측정값 추세 반영
# tool_wear_min_std 
: tool wear rolling std -> 변동성 확인
# torque_nm_ewma 
: torque EWMA -> 최근 토크 추세
# torque_nm_std 
: torque rolling std -> 토크 변동성 확인
# delta_temp 
: ΔT (air_temp - rolling_mean) ->  설비 내부 열 축적 정도를 시뮬레이션

--> EWMA 와 rolling std는 동적 Threshold 계산에 사용됨
ΔT 는 냉각/발열 이상 탐지용 지표

# Residual / 예측 기반 KPI
torque_pred : 회전수 대비 예상 토크 -> LinearRegression 기반 예측
residual : torque residual -> 실제 torque - 예상 torque
residual_ewma : residual EWMA ->  residual 추세 반영
residual_std : redidual rolling std -> residual 변동성
risk_level : 위험 수준 -> residual 기반 Risk 판단(Normal/High)

--> Residual 기반 Risk 는 예지보전 의사결정에 직접 활용 가능 
예: residual 이 크면 설비 이상 가능 -> 점검 필요

