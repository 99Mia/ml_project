# Anomoly Detection
- 이상치 탐지
" 본 프로젝트에서는 고장 데이터의 희귀성과 불확실성을 고려해 Rule 기반 이상치로 물리적 한계를 잡고,
Isolation Forest로 정상 운전 패턴 이탈을 탐지했습니다"

면접 질문: 현장에서는 알람 남발이 제일 싫다. 이거 실무 써본거 맞나?
답: "단독으로 쓰면 false alarm이 늘어날 수 있습니다.
그래서 본 프로젝트에서는 Rule 기반 이상치와 AI 이상치를 결합하고, 이상치 score와 level을 나눠
단계적으로 알람을 설계했습니다."
"물리적 임계치를 벗어난 경우는 즉시 알람, AI 이상치는 score가 일정 수준 이하로 누적될 때
알람을 발생시켜 운영자 피로도를 줄였습니다."
--> 비지도 모델을 '알람 생성기'가 아니라 '이상 후보 탐지기'로 사용합니다.

면접 질문 : AI가 왜 이상이라고 했는지 설명 못하면 못 쓴다.
답: "Isolation Forest는 개별 센서 값이 아니라 센서 조합의 희귀성을 기준으로 판단합니다.
    RPM, 토크, 온도는 각각 정상 범위지만, 이 조합은 과거 정상 운전 데이터에서 거의 발생하지
    않았기 때문에 이상 패턴으로 판단했습니다."
--> 시각화:
RPM-Torque 산점도에 정상과 AI 이상치를 겹쳐 시각화해 운영자가 직관적으로 이해할 수 있게 했습니다.
--> AI 판단을 공정 언어로 번역해서 설명합니다.


면접 답 : "설비 열화나 공구 마모는 개별 센서 임계치를 넘는 사건이 아니라, 센서간 관계가 서서히
          변하는 과정입니다. Isolation Forest는 이 관계 변화로 인해 정상 패턴 공간에서 이탈하는
          지점을 조기에 감지합니다."   

면접 질문 : 그럼 언제 지도학습으로 전환하나요?  (비지도만 고집하는 사람인가?)
답: "고장 유형이 안정적으로 정의되고, 동일한 고장이 반복적으로 발생해 라벨 신뢰도가 확보되면
     지도학습으로 전환합니다."
전환조건: 고장 데이터가 일정 수 이상 누적, 고장 유형이 명확히 구분 가능, 현장 기준이 일정 기간 유지
전환방식: 비지도 모델은 계속 사용하고, 지도학습 모델을 보조 판단 모델로 추가합니다.
--> 완전 대체가 아니라 하이브리드 구조입니다. 
--> 비지도에서 지도로 가는거는 성숙 단계의 자연스로운 진화입니다.
"초기에는 고장 데이터가 희귀하기 때문에 비지도 이상치 탐지가 현실적이며, 데이터가 누적되면 지도학습을 결합한 하이브리드 구조로 확장하는 것이 현장 표준입니다" 


면접 답 : "회전수와 토크는 출력과 부하 관계로 인해 정상 공정에서는 강한 음의 상관관계를 가집니다.
          본 프로젝트에서는 이 물리적 상관 구조가 유지되는지를 기준으로 이상 상태를 탐지하며, 
          해당 관계가 깨지는 시점을 설비 열화 및 공구 마모의 초기 신호로 해석합니다"
AI가 똑똑한게 아니라, 공정 물리를 숫자로 학습했을 뿐이다.






## AI 이상치를 왜 쓰는가?? (예지보전 개념)
# 설비 열화/ 공구 마모/ 공정 편차 증가는 갑자기 spec을 넘는 사건이 아니라 정상 패턴에서 서서히
# 멀어지는 과정이고, Isolation Forest 는 그 멀어지는 조짐을 가장 먼저 잡아냅니다.
- 현장 : " 수치는 괜찮은데, 뭔가 평소랑 다르다"
이게 바로 조합 패턴 변화이다.
값은 다 정상인데 RPM 대비 Torque가 예전보다 높다, Torque 대비 Tool Wear 증가 속도가 빨라진다
이게 개별 센서는 정상인데, 관계(조합)은 변화한다.
이걸 Rule 기반 / 단일 임계치로는 절대 못잡는다.
# *** Isolation Forest 가 보는 관점
- Isolation Forest 는 "이 센서 조합, 과거 정상 운전 데이터에서 자주 보던 패턴인지, 아닌지"
이상 : "값이 작거나 큰 것 x", "정상 패턴 공간에서 멀리 떨어진 것 o"
1. 설비 열화 감지
정상 : 초반에는 RPM -> Torque 패턴이 일정
열화 진행 : 같은 RPM -> Torque 미세 상승 (진동 조합 변화)
아직 spec 이내지만, 과거 정상 운전에서 이런 조합은 거의 없음
그래서 isolation forest는 정상 클러스터에서 점점 벗어났다고 판단
-> 이상 score 서서히 악화

2. 공구 마모 추정
(같은 작업을 더 힘들게 수행하게 됨)
** 데이터 관점
- Tool Wear 값 자체는 천천히 증가
- Torque 상승 + RPM 유지
- 열 발생 패턴 변화
--> 이 다변량 조합이 "새로운 희귀 패턴"으로 인식됨
그래서 아직 불량 x , spec 초과 x , 하지만 ai 이상 score 상승

3. 공정 편차 증가 감지
공정 편차는 
이상일때 : 평균 같음, 분산 커짐, 조합 패턴 흔들림
정상일때 : 평균 같음, 분산 작음, 조합 패턴 일정
평균은 정상이니까 Rule을 통과하지만
분산,조합 변화는 AI 가 감지한다.
--> 데이터가 정상 밀집 영역에서 퍼지기 시작하면, 이상 징후로 본다
--> 그래서 AI 이상치는 "조기 경보" 이다. (불량 되기 전 징후 탐지)
--> 현장에서는 '지금 당장 멈추자x', '점검 스케줄 당겨보자o' 

### Isolation Forest

- 트리 기반으로 이상치를 탐지하는 알고리즘
- 이상치(Outlier)는 정상 데이터와 비교했을 때 드물고, 분리되기 쉬운 데이터라는 특징을 이용
- 데이터를 무작위로 분할(random partitioning)하면서, 정상데이터보다 이상치가 더 빨리 분리(isolated) 되는 성질을 이용
- 고차원 데이터에 효율적
- 비지도 학습
--> 지도학습은 데이터 X와 y 가 있어야 학습이 가능하다
예: x = 센서 데이터, y = 정상(0)/이상(-1)
모델이 정답을 보고 패턴을 학습 -> 예측
--> 비지도 학습은 데이터에 정답 레이블(y)가 없음, 모델이 데이터의 구조나 패턴을 스스로 찾아내야함
정상데이터에서 벗어난 것들을 이상이라고 찾아냄

Isolation Forest 동작 방식
- 데이터 포인트를 무작위로 분할(random partitioning)
- 정상 데이터 -> 다른 데이터와 섞여있어서 분리되기 어려움
- 이상치 -> 혼자 떨어져 있는 경우가 많아 분리되기 쉬움
즉, 정상/이상치 레이블 없이도 데이터를 관찰해서 이상치를 판단 가능
*** Isolation Forest 는 어떤 값이 다른 값과 얼마나 다르게 분리되는가에 기반
데이터에 레이블(Label)이 있다는 것 : 
  레이블(Label) : 정답 / 결과 / 타겟 값 
  설비 상태가 정상, 이상이라고 되어있는게 레이블이다 (입력X 와 정답 y 쌍이 있는 경우)
데이터에 레이블이 없는 경우 :
  정답이 없음, 오직 관측값만 존재
  정상/이상 이런 정답이 없고 오직 관측값만 존재한다
  모델은 데이터를 분석해서 패턴/분포/밀도를 보고 이상치를 판단

**** 고급 
- AI anomaly score 시간 추세 그래프
- score가 특정 기간 이상 지속되면 정비 알람
- 공구 교체 시점 전후 score 변화 비교


Isolation Forest 의 출력:  (isolation forest 는 원인을 말해주지 않는다)
1. anomaly score (연속값)
decision_fuction -> score 
- 보통 0 근처 = 정상
- 음수로 갈수록 이상
- 절대값은 의미 없음 -> 상대 비교가 핵심
2. anomaly label
predict() -> 1 : 정상
predict() -> -1 : 이상

모델은 이상이다/아니다 만 말함
왜 인지는 말해주지 않는다. 

그러면 RPM 대비 Torque가 올라갔다는 건 누가 판단 하는지?
-> 사람 + 후처리 로직이 한다

### Isolation Forest 실무 구조
# 1. AI 가 이상한 row를 표시
     timestamp      rpm  torque     anomaly_score
2020.11.04.10:46 | 1500 |   45   | -0.15             -> 경계/이상
AI가 이 조합, 예전이랑 다름 이라고 표시함

# 2. 해석용 파생지표 생성(중요) -> 파이썬에서 전처리/분석/시각화
이거는 AI 모델에 넣기 위해 만든 변수가 아니라, AI 결과를 설명하기 위해 만든 변수이다.
1. RPM-Torque 잔차 (Residual)
정상 : Torque ≈ f(RPM)  --> rpm 이 주어지면 torque 가 거의 정해진 범위 안에 있다

f(RPM) 은 데이터로 만드는 기준선 만드는 방법 3가지
1-1 단일 기준선 (기본, 반드시 먼저)
Torque ≈ f(RPM) 하나만 만드는 것
"정상 공정의 평균적인 물리 관계"


1-2 구간별 기준선 (실무)

1-3 조건별 기준선 (고급/실무형)
-> 공정 조건이 명확이 다른경우 
- product_type
- 공정 단계
- tool 교체 전/후

2. Residual 시각화 (열화 감지 핵심)
2-1. RPM-Torque + 기준선

2-2. residual 시간 추세

3. anomaly score + residual 같이 보기 (실전)


expected_torque = f(rpm)
# 3. 이상 데이터의 공통점 분석
# 4. 현장 설명
" 해당 시점의 RPM 은 정상 범위이나, 동일 RPM 조건 대비 Torque 요구량이 과거 대비 xx% 만큼 증가했습니다. 이 구간에서 anomaly score가 지속적으로 증가하고 있어 설비 저항 증가로 인한 열화 초기 단계로 판단됩니다."

질문 : 왜 딥러닝을 안쓰고 Isolation Forest를 썼는지?
답 : "고장 데이터가 희귀한 환경에서는 비지도 이상치 탐지가 더 적합하고, 무엇보다 센서 간 
      물리 관계를 사람이 해석할 수 있어야 하기 때문입니다. "
      "고장 데이터가 희귀한 환경에서는 고장을 직접 학습하는 지도학습보다 정상 패턴을 학습해
      이탈을 감지하는 비지도 이상치 탐지가 더 현실적입니다."



고장 데이터가 희귀하면, 지도학습은 '배울 수 있는 정보 자체가 부족' 하고 비지도 이상치 탐지는
'정상 상태를 학습'하기 때문에 더 안정적이다
** 제조 현장의 데이터 구조는
정상 운전 데이터  : 99%
고장 데이터 : 0.1 ~ 1%
심지어 고장 유형도 다양하고 같은 고장이 다시 안 날 수도 있다
즉, 고장은 희귀하고 다양하고 재현이 불가하다

지도학습(RandomForest, XGBoost 등)은 클래스 불균형과 고장 정의 자체가 불완전하다,
그리고 미래 고장은 과거에 없다. -> 지도학습은 과거에 본 패턴만 맞출 수 있다. 하지만 제조 현장은
설비 노후, 공정 변경, 소재 변경 등 새로운 고장은 처음보는 패턴이다.

**************
그래서 Isolation Forest(비지도 학습)이 되야하는 이유
1. 고장을 배우는게 아니라, 정상을 배우고, 벗어나면 이상으로 본다.
정상 데이터는 많기 때문에 매일 쌓이고, 신뢰도가 높고, 기준이 명확하다.
--> 모델이 안정적으로 학습이 가능하다.
2. 새로운 고장도 잡을 수 있다
Isolation Forest 관점에서 "이 조합의 센서 패턴, 과거 정상 데이터에서 거의 본 적이 없다."
--> 이건 과거에 없던 고장, 아직 고장 라벨 없는 이상
--> 예지보전의 본질
3. 라벨에 의존하지 않는다. 
--> 고장 기록 없어도 ok, 작업자 판단 없어도 ok, -> 현장 적용이 훨씬 빠름

*********
RPM 정상, Torque 정상, Tool Wear 정상
하지만 이 세개의 데이터 값 조합이 과거 정상 운전에서 거의 없었음
비지도 모델 판단: 개별 값은 정상인데 조합이 비정상이다.
이거는 Isolation Forest 만 가능하다



### LOF
LOF 는 밀도 기반 이상치 탐지 알고리즘이다
핵심 아이디어: 
- 주변 데이터 보다 밀도가 낮은 점 -> 이상치
- 정상 데이터는 주변과 비슷한 밀도를 가짐
말 그대로 국소(local)이상치를 탐지할수 있다.
데이터가 여러 클러스터로 나뉘어 있어도 각각의 밀도를 비교할 수 있다

LOF 동작원리:
- 각 데이터 포인트 주변 k개의 이웃 (neighbors) 찾기
- 주변 밀도 계산 -> 주위에 점이 많으면 밀도 높아서 정상, 주위에 점이 적으면 밀도 낮아서 이상치
- LOF 값 이 1보다 크면 주변보다 밀도가 낮아서 이상치
- LOF 값이 1과 비슷하거나 이하이면 정상

LOF 공식 = 평균주변밀도 / p 의 밀도
LOF 값이 클수록 이상치일 가능성이 높다
일반적으로 LOF > 1.5 정도를 이상치 기준으로 사용한다

장점: 국소 이상치 탐지 가능, 클러스터 형태에서도 정상/이상 구분
LOF 는 클러스터 안/밖을 따지지 않는다, 대신 x 점 주변에 이웃이 얼마나 있고, 그 이웃들끼리는 얼마나 빽빽한가?

단점: k 값 설정에 민감
** 클러스터 형태: 비슷한 데이터들이 모인 집단
** 데이터셋에 비슷한 성질을 가진 점들이 덩어리처럼 모여있는 형태
--> 전체 데이터가 아니라 주변 밀도, LOF는 이상치 판단 시 전체 데이터 분포를 기준으로 하지 않음
--> 각 데이터 점 주변 k개의 이웃과 비교 -> 국소(local) 관점
--> 즉, 멀리 떨어진 다른 클러스트가 있든, 전혀 신경쓰지 않음
x점 주변에 이웃이 거의 없고, 이웃까지 거리가 멀면 x 의 밀도가 매우 낮다. 
이웃들의 밀도는 상대적으로 높다
결과: LOF값 > 1  -> 이상치


### IQR
IQR은 사분위 범위이다
- 데이터의 중앙 50% 범위를 사용해서 이상치를 찾는다
- 통계 기반 (비 AI) 방법
머신러닝 모델아니고, 학습 없다
사분위수 (Quartile) 부터 Q1(1사분위), Q2(중앙값), Q3(3사분위)

이상치 기준
IQR = Q3-Q1
상한 : Q3 + 1.5 x IQR
하한 : Q1 - 1.5 x IQR

이 범위를 벗어나면 이상치

IQR 활용 상황: 물리적으로 말도 안되는 값 (센서 오류, 통신 에러)
예 : 온도 -999, 진동 갑자기 10배
-> 이건 AI 까지 갈 필요 없음 
여기서 쓰는 것은 IQR, Rule 기반 (Rule 은 사람이 미리 정한 명시적인 조건(규칙), 이 조건이면 무조건 이상)
--> 현장에서는 이걸 제일 먼저 적용한다 (Rule)
"이 값은 상식적으로 말이 안된다"
예: 온도 < 0 , 온도 > 200 이면은 이상
    진동 RMS > 10 이면은 이상
    센서값 == -999 이면은 통신오류
    이런식으로 현장에서는 이거를 제일 먼저 적용한다


  이때 현장에서는
  # IQR (사분위수)
  *** 데이터 분포 기준으로 통계적 이상치 찾기가 목적
  # Rule (명시적 규칙)
  *** 사람이 정의하고 센서 오류 제거가 목적
  # min/max threshold (절대 임계값)
  *** 물리적 한계를 기준으로 장비 보호가 목적
  --> 센서 또는 공정에서 허용 가능한 최소/최대값
  예.
  온도 min 0도, max 180도, 이유: 센서스펙
  압력 min 0 bar, max 10 bar 이유: 장비 허용
  전류 min 0 A, max 50 A 이유: 차단기 한계
  만약에 온도 > 180 -> 이상
         압력 < 0  -> 이상
  특징: 데이터 분포와 무관, 센서 스펙/설비 매뉴얼을 보고 확인
  
  # 공정 한계값(Spec Limit)
  *** 품질 기준으로 불량 판단이 목적
  spec limit 이란?
  제품 품질을 보장하기 위한 허용범위
  (고객 요규, 설계 기준, 품질 규격)
  보통 LSL (Lower Spec Limit), USL (Upper Spec Limit)
  ex.
  제품 치수 
  목표 : 10.00 mm
  LSL : 9.95
  USL : 10.05
  9.95 <= 치수 <= 10.05 이외의 치수는 모두 불량
  ** 이건 센서 이상이 아니라 품질 이상 / 불량 판단 기준


### 현장 실제 적용 흐름
1. Rule / min-max -> 센서 오류 제거
2. Spec Limit(공정 한계값) -> 품질 이상 판단
3. IQR -> 분포상 튀는 값 제거
4. AI (Isolation Forest, LOF) -> 숨은 이상 패턴 탐지

******* 
면접
"Rule 기반과 min/max threshold(절대 임계값)로 센서 스펙을 벗어난 값과 통신 오류를 먼저 제거하고,
Spec Limit(공정 한계값)으로 품질 기준 위반 여부를 판단합니다. 
이후 정제된 데이터에 대해 IQR과 이상 탐지 모델을 적용합니다."

질문 : 
Spec Limit(공정 한계값)과 AI 이상치가 충돌하면 현장은 어떻게 판단하는지??
답 : 현장은 Spec LImit(공정 한계값)을 최우선으로 한다
AI 이상치는 조치 신호(Early Warning)이다
-> 이 우선순위는 거의 모든 대기업 제조 현장에서 동일하다

Spec Limit = 계약 + 품질 책임
- 고객 요구사항
- 설계 규격
- 품질 보증(QA)기준
Spec 위반 = 불량이다.
-> 변명 없이, AI가 뭐라고 해도 불량이다.
그래서 Spec Limit 은 절대 기준이다

*** 충돌 상황 4가지
1. Spec 정상 / AI 정상

2. Spec 위반 / AI 정상
-> 즉시 불량, AI 판단 무시, 공정 정지 또는 격리

3. Spec 정상 / AI 이상치 (****)
-> 예지보전 / 사전대응 
- 아직 불량은 아니지만 "이상 징후"
- 현장 조치: 점검 알람, 유지보수 계획, 공정 조건 미세 조정
--> 이게 AI 의 진짜 역할

4. Spec 위반 / AI 이상치 (****)
-> 가장 위험, 즉시 조치, Root Cause 분석


### AI 이상치 활용
불량 판정용이 아니라, 불량 되기 전 탐지
- 설비 열화 감지
- 공구 마모 추정
- 공정 편차 증가 감지
"아직 spec 안넘었는데, 분위기가 이상하다"

### AI 이상치는 KPI 에서 어떻게 표현되나
현장 대시보드에서는 절대 섞지 않음
- 품질 KPI -> Spec 기준 (품질팀/생산팀)
- AI 이상치 KPI 
-> Risk / Anomaly Score  (설비/공정/스마트팩토리팀) -> 내가 만들거
-> 기준: 모델 출력
-> 의미: 앞으로 일어날 가능성 - 미래 예측 지표
ex. Anomaly Score, Rist Level, Abnormal Trend Index 
** 대시보드 구조
상단 - [품질 불량률 (0.3 정상)] [AI 이상 위험도 (High 위험)] [설비 가동률 (98%)]
중단 - AI 이상치 KPI 카드
- 평균 Anomaly Score - 최근 1시간 평균
- 위험 설비 수 - High 이상 설비 개수
- 이상 지속 시간 - 연속 이상 발생 시간
- 위험 추세 - AI 이상 위험도가 지금 높으냐/낮으냐가 아니라, 시간에 따라 어디로 가고 있느냐를
나타내는 지표이다. 즉, 점점 위험에 지고 있는지, 안정되는지
  위험추세 3가지 타입(현장 표준)
  1. 상승 (Increasing)
  Anomaly Score 가 연속적으로 증가
  설비 상태가 빠르게 악화 중
  - 현장 의미: 즉시 점검 계획, 조기 유지보수 검토
  2. 유지 (stable)
  점수는 높지만 변화 없음
  일시적 노이즈일 가능성
  - 현장 의미: 관찰 유지, 알람 억제
  3. 하락 (Decresing)
  위험 점수가 감소
  공정 안정화
  - 현장 의미: 정상 복귀 판단, 알람 해제

  위험 추세 계산
  1. 시간 윈도우 설정 (최근 10분, 30분, 1시간)
  - short Window(단기) 5~10분 -> 
  목적: 급격한 이상
  특징: 노이즈 많음
  용도: 실시간 경보 보조
  "지금 갑자기 이상해졌다"
  - mid Window(중기) 30~60분 ***
  목적: 실제 설비 상태 변화
  특징: 노이즈 적음
  용도: 위험 추세 판단
  "지속적으로 나빠지고 있다"
  - long Window(장기) 4~24시간
  목적: 열화(노후) 감지
  특징: 매우 안정
  용도: 유지보수 계획
  "이 설비는 최근 며칠간 계속 안 좋아진다"
  2. Anomaly Score 평균 비교
  3. 변화 방향 판단

  if 최근 평균 증가율 > +5% -> 상승
  elif 변화율 -5% ~ +5%  -> 유지
  else > 하락
====================================
  KPI 카드 예시
  AI 이상 위험도 : High
  지속 시간 : 18분 (High 상태로 진입한 시점부터 지금까지. 중간에 Normal로 떨어지면 리셋)
  단기 추세: 위 화살표
  중기 추세: 위 화살표
  장기 추세: -> (가로 화살표) 유지. 현장에서는 관찰유지, 알람 억제
  --> 이 3개가 한 세트
=====================================
  KPI 정석 구성
  [AI 이상 위험도] high
  [위험 추세] 위 화살표
  [지속 시간] 18분
  -> 여기서 위험 추세 화살표는 "중기 추세 기준"
  -> 단,장기는 보조 판단용
=========================================
  단,중,장기 지속시간은 어디에 쓰는지?
  내부 판단용(보이지 않게)
  단기 지속: 6분
  중기 지속: 18분
  장기 지속: 0분 (아직 기준 미달)
  이걸 가지고 알람 여부를 결정함
  --> 지속시간은 AI 모델이 만드는 게 아니다. 
  AI/Rule/Spec Limit 결과를 Boolean(정상,이상)으로 만든 뒤 그 상태가 얼마나 오래 유지됐는지를 계산한 '로직'이다 
  지속 시간은 모델이 아니라, 상태 누적 로직이다 (Spring boot 에서 kpi 계산하듯이)

  알람 로직
  if (중기추세가 상승) and (중기 지속 >= 15분) and (단기 추세 증가)
  -> 점검 알람
  if (장기 추세 증가) and (장기 지속 >= 3일) 
  -> 예방 정비 계획


  *****
  면접
  "AI 이상치는 단일 스코어보다 시간 추세를 함께 보여줘야 현장에서 의미 있는 판단이 가능합니다"
  "AI 이상치 추세는 시간 윈도우 설정에 따라 민감도가 달라지기 때문에 단,중,장기 윈도우를 분리해 경보와 유지보수 판단에 각각 활용합니다"
  "대시보드에는 현재 위험 레벨의 단일 지속 시간만 표시하고, (중기 추세 기준)
  단,중,장기 지속 시간은 알람 판단 로직에서 내부적으로 활용합니다"

  위험 추세 = AI 이상치가 지금 상태가 아니라 앞으로 향하는 방향을 보여주는 KPI





**********
면접
"Spec Limit은 절대적인 품질 기준이고, AI 이상 탐지는 Spec 위반 이전에 사전 조치를 위한 보조 지표로 사용됩니다."
-> 불량을 줄이는게 아니라, 불량이 발생하지 않게 만드는 것.
AI 는 그걸 위한 도구이다.


### 이상치 전체 구조 레이어
# Layer 1. 이상 판단 소스 (Multiple Singals)
- 여기서는 여러 방식이 동시에 존재한다
1. Rule 기반
- IQR (사분위수)
- min/max threshold (절대 임계값)
- Spec Limit (공정 한계값)
-> 결과 : rule_anomaly = True / False
rule_anomaly =(
  minmax_anomoly 
  or spec_limit_anomaly
  or iqr_anomaly
)
==> 이 값은 무조건 이상이다 라고 사람이 미리 정의해 놓은 이상치 값이다.

2. AI 기반
- LOF
- Isolation Forest
- AutoEncoder
- Random Forest(정상 데이터 학습)
-> 결과 : ai_anomaly_score = 0.82
          ai_anomaly = True (threshold 초과 시)
==> 이 값은 정상 패턴이 원래 이런데... 지금은 뭔가 다르다를 데이터로 학습하는 것이다
** AI 가 보는 관점
- 온도는 정상 범위, RPM 도 정상 범위, 토크도 정상 범위
-> 하지만 조합이 (3,40,30) 이렇 숫자가 정상이지만 ,이 조합이 예전에는 거의 없던 패턴이면은
이런 숨은 이상 패턴을 판단하는게 

그 이후 운영 로직/판단 로직에서 Rule 결과랑 AI 결과를 비교한다
[Rule Engine] -> rule_anomaly
[AI MOdel] -> ai_anomaly_score
[Decision Layer] -> 최종 판단
ex. 
Rule: 정상
AI : 이상 위험도 High
-> 관찰 유지/ 알람 억제/ 관리자 확인
ex.
Rule : Spec Limit 초과
AI : 정상
-> 즉시 알람 (AI 무시)

# Layer 2. 이상 판단 통합 (Decision Layer)
Spring boot에서 만들어야 하는 로직 

If Spec Limit 위반 : 
      anomaly = True (강제)
Elif AI score > 0.8 AND Rule 위반:
      anomaly = True
Elif AI score > 0.95:
      anomaly = True
Else:
      anomaly = False

이 단계에서 나오는건 딱 하나다
is_anomaly = Ture / False 

# Layer 3. 지속 시간 계산 (State Tracking)
Spring boot 에서 만들어야하는 상태 누적 로직 

IF is_anomaly == True:
    duration += Δt
ELSE:
    duration = 0

이걸로 단기 지속 6분, 중기 지속 18분, 장기 지속 0분 이렇게 나오는 것이다

# AI 이상 위험도 = 종합 판단 KPI
입력: 
- AI anomaly score
- Rule 위반 개수
- Spec Limit 위반 여부
- 단/중/장기 지속 시간
출력:
AI 이상 위험도 = Low / Medium / High

If spec Limit 위반:
 Risk = High
Elif 중기 지속 > 15분 and AI score > 0.8:
 Risk = High
Elif 단기 지속 > 5분:
 Risk = Medium
Else:
 Rist = Low

이게 AI KPI 이다

# 품질 불량률 (담당: 품질팀)
- 출처: 품질 데이터
- 담당: 품질팀
- 성격: 결과 KPI
불량 수 / 생산 수량 (%)
--> 이미 발생한 결과

# AI 이상 위험도 
- 출처 : 설비/공정/센서
- 담당 : 스마트 팩토리팀
- 성격 : 사전 경고 KPI
"앞으로 문제가 생길 가능성"


### AI 이상치 KPI 대시보드
# KPI 카드
[품질 불량률] 0.3 % (품질팀)
[AI 이상 위험도] High (AI)
[공정 안정도] 92%
[알람 상태] 관찰 유지

# KPI 카드 클릭시 상세 (운영자가 보는 구조)
AI 이상 위험도 : High
- AI anomoly score: 0.87
- Spec Limit 위반 : 없음
- Rule 위반: 진동 RMS 초과
- 단기 지속: 6분
- 중기 지속: 18분
- 장기 지속: 0분

# 그 다음단계 : AI Score 를 KPI 로 바꾸는 공식 설계, 알람 억제(Alarm Fatigue)전략








